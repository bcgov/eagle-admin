name: Deploy to Prod

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to promote (e.g., v1.2.3)'
        required: true
        type: string

permissions: write-all

env:
  OPENSHIFT_NAMESPACE_TOOLS: 6cdc9e-tools
  OPENSHIFT_NAMESPACE_PROD: 6cdc9e-prod
  IMAGE_NAME: eagle-admin
  APP_NAME: eagle-admin

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format v1.2.3"
            exit 1
          fi

      - name: Verify Git tag exists
        run: |
          if ! git rev-parse "${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Git tag ${{ inputs.version }} does not exist"
            echo "Please deploy to test first to create the version"
            exit 1
          fi
          echo "Git tag ${{ inputs.version }} verified"

  deploy:
    name: Deploy to Prod
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: "4.14"

      - name: Log into OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: ${{ env.OPENSHIFT_NAMESPACE_TOOLS }}

      - name: Verify image tag exists
        run: |
          echo "Verifying image tag ${{ inputs.version }} exists..."
          if ! oc -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }} get imagestreamtag ${{ env.IMAGE_NAME }}:${{ inputs.version }} &>/dev/null; then
            echo "Error: Image tag ${{ inputs.version }} does not exist"
            exit 1
          fi
          echo "Image tag verified"

      - name: Tag version as prod
        run: |
          echo "Tagging ${{ inputs.version }} as prod..."
          oc -n ${{ env.OPENSHIFT_NAMESPACE_TOOLS }} tag \
            ${{ env.IMAGE_NAME }}:${{ inputs.version }} ${{ env.IMAGE_NAME }}:prod

      - name: Deploy to prod
        run: |
          oc -n ${{ env.OPENSHIFT_NAMESPACE_PROD }} rollout restart deployment/${{ env.APP_NAME }}
          oc -n ${{ env.OPENSHIFT_NAMESPACE_PROD }} rollout status deployment/${{ env.APP_NAME }} --timeout=5m
          
          echo "Deployment successful!"
          oc get pods -n ${{ env.OPENSHIFT_NAMESPACE_PROD }} -l app.kubernetes.io/name=${{ env.APP_NAME }}
